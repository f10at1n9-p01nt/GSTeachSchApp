<script>
  const RANKED_CLASSES = [];

  document.getElementById("submit-schedule").addEventListener("click", getSchedule);
  document.getElementById("submit-preferences").addEventListener("click", submitPreferences);
  document.getElementById("clear-preferences").addEventListener("click", clearRankings);
  document.getElementById("filter-dow").addEventListener("click", filterDays);
  document.getElementById("group-ranked").addEventListener("click", sortDisplayedClassesByRank);

  const classListUl = document.getElementById("class-list")
  const classListInputs = classListUl.querySelectorAll('input')
  
  classListInputs.forEach((element) => {
    element.addEventListener('input', (e) => updateRankedClassesArr(RANKED_CLASSES, [e.target.value, e.target.id]))
  })

  // Called when "Get Schedule" button is clicked
  function getSchedule() {
    google.script.run.withSuccessHandler(printSchedule).checkSchedule(document.getElementById('username').value)
  }

  // Called when "Submit Preferences" button is clicked
  function submitPreferences() {
    const usernameField = document.getElementById('username');
    const numberOfClasses = document.getElementById('number-of-classes').value;
    const notAssignedCheckbox = document.getElementById('no-new-classes');
    let wishToBeScheduled = '';
    
    console.log(notAssignedCheckbox.checked);

    if (notAssignedCheckbox.checked === true) {
      wishToBeScheduled = 'no'
    } else {
      wishToBeScheduled = 'yes'
    }

    const username = usernameField.value;
    // const coursePreferences = getRankedIds();

    // google.script.run.addUsername(username, coursePreferences, numberOfClasses, wishToBeScheduled);
    google.script.run.addUsername(username, RANKED_CLASSES, numberOfClasses, wishToBeScheduled)
    alert(`${RANKED_CLASSES.length} classes have been submitted for ${username}.`)

    usernameField.value = '';
    clearRankings();
  }


  // Called when "Clear Preferences" button is pushed
  function clearRankings() {
    const ul = document.getElementById('class-list');
    const classes = ul.getElementsByTagName("li");

    RANKED_CLASSES.length = 0;

    for (let i = 0; i < classes.length; i++) {
      classes[i].querySelector("input").valueAsNumber = NaN;
    }
  }

  // Called when "Filter" button is clicked
  // Keeps rank, but only if the day isn't cleared - need to find way for rankings to persist
  function filterDays() {
    let checkedBoxes = document.querySelectorAll('input[name="dow"]:checked');
    let days = [];
    checkedBoxes.forEach(checkbox => days.push(checkbox.value));

    // let rankedIds = getRankedIds();
    // rankedIds.forEach((e) => updateRankedClassesArr(RANKED_CLASSES, e));
    // console.log(RANKED_CLASSES)

    // google.script.run.withSuccessHandler(printClasses).getClasses(days, rankedIds)
    google.script.run.withSuccessHandler(printClasses).getClasses(days, RANKED_CLASSES)
  }


  function updateRankedClassesArr(arr, classRankandId) {
    // console.log(`arr is ${arr} and classRank is ${classRankandId}`)
    const i = arr.findIndex((e) => e[1] === classRankandId[1]);
    if (i > -1) {
      arr.splice(i,1,classRankandId)
    } else {
      arr.push(classRankandId);
    }
    console.log(RANKED_CLASSES)
  }


  // Called when "Group Ranked" button is clicked
  function sortDisplayedClassesByRank() {
    const rankedCourses = getRankedIds();

    google.script.run.withSuccessHandler(printClasses).findRankedClasses(rankedCourses)
  }


  // Displays username's schedule on app
  // argument 'schedule' is 2D array from checkSchedule(username) with username's schedule
  function printSchedule(schedule) {
    const ul = document.getElementById('teacher-schedule');

    // Clears any schedule already printed
    while (ul.firstChild) {
      ul.removeChild(ul.lastChild);
    }

    // Loop through the schedule and create an element with appropriate classes and append to ul
    for (let i = 0; i < schedule.length; i++) {
      let newEl = document.createElement('li');
      newEl.classList.add("ml-5", "mt-3");
      let newText = document.createTextNode(`${schedule[i][0]} ${schedule[i][1]}`)
      newEl.appendChild(newText);
      ul.appendChild(newEl);
    }
  }


  // Returns array with rank and ID for any ranked class
  function getRankedIds() {
    const ul = document.getElementById('class-list');
    const classes = ul.getElementsByTagName("li");
    let rankId = [];

    for (let i = 0; i < classes.length; i++) {
      if (classes[i].querySelector("input").valueAsNumber) {
        let idArr = classes[i].innerHTML.split('>'); // separate the <input> tag from the data into an array
        idArr.shift(); // remove the first element from the array, which is the <input> stuff
        rankId.push([classes[i].querySelector("input").valueAsNumber, idArr[0].split(' ')[0]]); // add [rank, ID] to rankId
      }
    }

    return rankId;
  }

  // Called by filterDays(). Attribute "classes" is <input> ready array of classes
  function printClasses(classes) {
    const ul = document.getElementById("class-list");
    // Clear currently printed list
    while (ul.firstChild) {
      ul.removeChild(ul.lastChild);
    }

    // Make new list
    for (let i = 0; i < classes.length; i++) {
      let newEl = document.createElement('li')
      newEl.classList.add("ml-5", "mt-3");
      newEl.innerHTML = classes[i]
      ul.appendChild(newEl)

      newEl.querySelector('input').addEventListener('input', (e) => updateRankedClassesArr(RANKED_CLASSES, [e.target.value, e.target.id]))
    }
  }


</script>