<script>
  const RANKED_CLASSES = [];

  document.getElementById("submit-schedule").addEventListener("click", getSchedule);
  document.getElementById("submit-preferences").addEventListener("click", submitClick);
  document.getElementById("clear-preferences").addEventListener("click", clearRankings);
  document.getElementById("filter-dow").addEventListener("click", filterDays);
  document.getElementById("group-ranked").addEventListener("click", sortDisplayedClassesByRank);
  document.getElementById("clear-alert").addEventListener("click", clearAlert);


  document.addEventListener("DOMContentLoaded", addTable);

  function addTable() {

    // google.script.run.withSuccessHandler(printClasses).getClasses(['mon', 'tue', 'wed', 'thu', 'fri', 'sun'], RANKED_CLASSES)
    google.script.run.withSuccessHandler(printClasses).getClasses(getSelectedDays(), RANKED_CLASSES)
    
  }


  // Called when "Get Schedule" button is clicked
  function getSchedule() {
    const username = document.getElementById('username').value;

    if (username) {
      google.script.run.withSuccessHandler(printSchedule).checkSchedule(username)
    }
    
  }

  // Called when "Submit Preferences" button is clicked
  function submitClick() {
    const username = document.getElementById('username')

    google.script.run.withSuccessHandler(validateForm).checkUsername(username.value);
  }


  function validateForm(dupe) {
    // Check if required username, number of classes fields are complete, and username hasn't submitted
    // Can add number of classes check quite easily
    const username = document.getElementById('username')
    const usernameIsValid = username.checkValidity();
    const numberOfClassesIsValid = document.getElementById('number-of-classes').checkValidity();
    
    if(!usernameIsValid || !numberOfClassesIsValid) {
      if (!numberOfClassesIsValid) {
        document.getElementById('no-class-number').classList.remove('hidden');
      }
      if (!usernameIsValid) {
        document.getElementById('no-username').classList.remove('hidden');
      }
      document.getElementById('alert').classList.toggle('hidden');
    } else if (dupe) {
      document.getElementById('dupe-username').classList.remove('hidden');
      document.getElementById('alert').classList.toggle('hidden');
    } else {      
      submitPreferences();
    }
  }


  // Clears the alert that indicates if a username or number of classes is missing
  function clearAlert() {
    document.getElementById('alert').classList.toggle('hidden');
    document.getElementById('no-username').classList.add('hidden');
    document.getElementById('no-class-number').classList.add('hidden');
    document.getElementById('dupe-username').classList.add('hidden');
  }


  // Called after submitClick() validates required fields
  // Sends username, ranked classes, and other form data to addUsername function which returns a row to send to spreadsheet
  function submitPreferences() {
    const usernameField = document.getElementById('username');
    const numberOfClasses = document.getElementById('number-of-classes').value;
    const notAssignedCheckbox = document.getElementById('no-new-classes');
 
    google.script.run.withSuccessHandler(alertUser).addUsername(usernameField.value, RANKED_CLASSES, numberOfClasses)
    clearRankings();
  }


  // Alerts user after submit of how many classes were submitted
  function alertUser(totalClassesAdded) {
    alert(`${totalClassesAdded} classes have been submitted for ${document.getElementById('username').value}.`)
    document.getElementById('username').value = '';
  }


  // Called when "Clear Preferences" button is clicked
  function clearRankings() {
    const tableBody = document.getElementById('class-table-body');
    const classes = tableBody.querySelectorAll('input')

    RANKED_CLASSES.length = 0;

    for (let i = 0; i < classes.length; i++) {
      classes[i].valueAsNumber = NaN;
    }
  }


  function getSelectedDays() {
    let checkedBoxes = document.querySelectorAll('input[name="dow"]:checked');
    let days = [];
    checkedBoxes.forEach(checkbox => days.push(checkbox.value));

    return days
  }

  // Called when "Filter" button is clicked
  function filterDays() {

    const days = getSelectedDays()

    google.script.run.withSuccessHandler(printClasses).getClasses(days, RANKED_CLASSES)
  }


  // Helper function that adds a class to RANKED_CLASSES when ranked
  function updateRankedClassesArr(arr, classRankandId) {
    const i = arr.findIndex((e) => e[1] === classRankandId[1]);

    if (i > -1) {
      arr.splice(i,1,classRankandId)
    } else {
      arr.push(classRankandId);
    }

    for (let i = 0; i < arr.length; i++) {
      if (arr[i][0] == '') {
        arr.splice(i, 1);
      }
    }

    console.log(RANKED_CLASSES)
  }


  // Called when "Group Ranked" button is clicked
  function sortDisplayedClassesByRank() {
    // const rankedCourses = getRankedIds();

    const days = getSelectedDays();
    console.log(days)

    google.script.run.withSuccessHandler(printClasses).findRankedClasses(days, RANKED_CLASSES)
  }


  // Displays username's schedule on app
  // argument 'schedule' is 2D array from checkSchedule(username) with username's schedule
  function printSchedule(schedule) {
    const tableBody = document.getElementById('current-table-body');

    // Clear currently printed list
    while (tableBody.firstChild) {
      tableBody.removeChild(tableBody.lastChild);
    }

    for (let row=0; row < schedule.length; row++) {
      let newRow = document.createElement('tr');
      for (let item=0; item < schedule[0].length; item++) {
        let newCol = document.createElement('td');
        newCol.innerHTML = schedule[row][item];
        newCol.classList.add('text-center');
        newRow.appendChild(newCol)
      }
      tableBody.appendChild(newRow);
    }
  }


  // // Returns array with rank and ID for any ranked class
  // function getRankedIds() {
  //   const ul = document.getElementById('class-list');
  //   const classes = ul.getElementsByTagName("li");
  //   let rankId = [];

  //   for (let i = 0; i < classes.length; i++) {
  //     if (classes[i].querySelector("input").valueAsNumber) {
  //       let idArr = classes[i].innerHTML.split('>'); // separate the <input> tag from the data into an array
  //       idArr.shift(); // remove the first element from the array, which is the <input> stuff
  //       rankId.push([classes[i].querySelector("input").valueAsNumber, idArr[0].split(' ')[0]]); // add [rank, ID] to rankId
  //     }
  //   }

  //   return rankId;
  // }

  // Called by filterDays(). Attribute "classes" is <input> ready array of classes
  function printClasses(classes) {
    const tableBody = document.getElementById('class-table-body');

    // Clear currently printed list
    while (tableBody.firstChild) {
      tableBody.removeChild(tableBody.lastChild);
    }

    for (let row=0; row < classes.length; row++) {
      let newRow = document.createElement('tr');
      for (let item=0; item < classes[0].length; item++) {
        let newCol = document.createElement('td');
        newCol.innerHTML = classes[row][item];
        newCol.classList.add('text-center');
        newRow.appendChild(newCol)
      }
      tableBody.appendChild(newRow);
    }

    addListenersToInputs();
  }

  function addListenersToInputs() {
    const tableBody = document.getElementById('class-table-body');
    const classInputs = tableBody.querySelectorAll('input')

    classInputs.forEach((element) => {
      element.addEventListener('input', (e) => updateRankedClassesArr(RANKED_CLASSES, [e.target.value, e.target.id]))
    })
  }

</script>